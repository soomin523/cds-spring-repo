<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.human.cds.mapper.CommunityMapper">

    <!-- 커뮤니티 게시물 목록 조회 -->
    <select id="getCommunityList" resultType="CommunityVO">
        SELECT *
        FROM community
        where isDeleted = false
        GROUP BY c_idx
        ORDER BY created_at DESC
    </select>
    
    <select id="getImagePathList" parameterType="_int" resultType="com.human.cds.vo.CommunityImgVO">
    	select * from image_paths
    		where postId = #{idx}
    </select>
    
    <select id="getCommunity" parameterType="_int" resultType="CommunityVO">
    	select * from community
    		where c_idx = #{idx}
    </select>
    
    <!-- 댓글 목록 조회 -->
    <select id="getCommentsByArticleId" parameterType="_int" resultType="com.human.cds.vo.CommunityContentVO">
        SELECT comment_id, c_idx, memberId, content, created_at
        FROM community_comments
        WHERE c_idx = #{idx}
    </select>
    
    <!-- 댓글 수 조회 -->
    <select id="getCommentCount" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM community_comments WHERE c_idx = #{idx}
    </select>
    
    <!-- 좋아요 수 조회 -->
    <select id="getLikeCount" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM community_likes WHERE c_idx = #{idx}
    </select>

    <!-- 게시물 삽입 -->
    <insert id="insertPost" parameterType="CommunityVO">
        INSERT INTO community (memberId, title, content, location, tag, rating)
        VALUES (#{memberId}, #{title}, #{content}, #{location}, #{tag}, #{rating})
    </insert>
    
    <select id="getCommunityCount" resultType="_int">
    	select max(c_idx) from community
    		where isDeleted = false
    </select>
    
    <insert id="insertImg" parameterType="com.human.cds.vo.CommunityImgVO">
    	insert into image_paths (postId, imagePath)
    		values(#{postId}, #{imagePath})
    </insert>
    
     <!-- 지역별 게시물 조회 -->
    <select id="getLocationList" resultType="CommunityVO">
    	select * from community
    		where location = #{location} and isDeleted = false
    </select>
    
    <!-- 최신/평점순 +지역별 게시물 조회 -->
    <!-- 최신순 지역별 조회 -->
	<select id="getlatestarea" parameterType="java.util.Map" resultType="CommunityVO">
	    SELECT * FROM Community
	    WHERE location = #{area}
	    ORDER BY created_at DESC
	</select>
	
	<!-- 평점순 지역별 조회 -->
	<select id="getratingarea" parameterType="java.util.Map" resultType="CommunityVO">
	    SELECT * FROM Community
	    WHERE location = #{area}
	    ORDER BY rating DESC
	</select>
	
	<!-- 최신순 전체 조회 -->
	<select id="getlatest" parameterType="java.util.Map" resultType="CommunityVO">
	    SELECT * FROM Community
	    ORDER BY created_at DESC
	</select>
	
	<!-- 평점순 전체 조회 -->
	<select id="getrating" parameterType="java.util.Map" resultType="CommunityVO">
	    SELECT * FROM Community
	    ORDER BY rating DESC
	</select>
	
	<!-- 검색어로(제목, id)로 게시물 조회-->
	<select id="getSeachList" resultType="CommunityVO">
		select * From community
		where memberId like concat ('%', #{search}, '%') or
				title like concat ('%', #{search}, '%')
				and isDeleted = false
	</select>
	
	<!-- 댓글 삽입 -->
	<insert id="insertComment" parameterType="map">
		insert into community_comments (c_idx, memberId, content)
			values(#{c_idx}, #{memberId}, #{content})
	</insert>
	
	<!-- 댓글 삽입 후 화면에 띄우기 위함 -->
	<select id="getComment" resultType="com.human.cds.vo.CommunityContentVO">
		select * from community_comments
			ORDER BY comment_id DESC
			LIMIT 1;
	</select>
	
	<!-- 좋ㅇㅏ요 삽입 -->
	<insert id="insertLike" parameterType="map">
		insert into community_likes (c_idx, memberId)
			values(#{c_idx}, #{memberId})
	</insert>
	
	<!-- 좋아요 이미 있는지 검사 -->
	<select id="likeDouble" parameterType="map" resultType="_int">
		select count(*) from community_likes
			where c_idx = #{c_idx} and memberId = #{memberId}
	</select>
	
	<!-- 좋아요 삭제 -->
	<delete id="deleteLike" parameterType="map">
		delete from community_likes
			where c_idx = #{c_idx} and memberId = #{memberId}
	</delete>
	
	<!--아직 안슨거  -->
    <!-- 게시물 수정 -->
    <update id="updatePost" parameterType="CommunityVO">
        UPDATE community
        SET title = #{title},
            content = #{content},
            location = #{location},
            tag = #{tag},
            updated_at = NOW()
        WHERE c_idx = #{id}
    </update>

    <!-- 게시물 삭제 -->
    <delete id="deletePost" parameterType="int">
        DELETE FROM community
        WHERE c_idx = #{id}
    </delete>

    <!-- 좋아요 증가 -->
    <update id="incrementLikes" parameterType="int">
        UPDATE community
        SET likes = likes + 1
        WHERE c_idx = #{id}
    </update>

    <!-- 댓글 수 증가 -->
    <update id="incrementComments" parameterType="int">
        UPDATE community
        SET comments = comments + 1
        WHERE c_idx = #{id}
    </update>

    <!-- 이미지 경로 삽입 -->
    <insert id="insertImagePath" parameterType="map">
        INSERT INTO image_paths (postId, imagePath)
        VALUES (#{postId}, #{fileName})
    </insert>



    <!-- 댓글 삭제 -->
    <delete id="deleteComment" parameterType="int">
        DELETE FROM community_comments WHERE comment_id = #{id}
    </delete>



</mapper>
